<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://use.typekit.net/paf7uxj.css">
  <title>Concordia 4th Space Events</title>
  <style>
    body {
      margin: 0;
      font-family: "gill-sans-nova-condensed", sans-serif;
      background: #111;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    #zoom-controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 9999;
      display: flex;
      gap: 10px;
    }

    .zoom-button {
      font-size: 2rem;
      color: white;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 8px;
      width: 50px;
      height: 50px;
      cursor: pointer;
      line-height: 1;
      text-align: center;
    }

    .zoom-button:hover {
      background: rgba(255,255,255,0.4);
    }

    .event-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      max-width: 3210px;
      max-height: 1080px;
      aspect-ratio: 3210/1080;
      overflow: hidden;
      box-sizing: border-box;
    }

    @media (max-aspect-ratio: 3210/1080) {
      .event-container {
        width: 100vw;
        height: calc(100vw * 1080 / 3210);
      }
    }

    @media (min-aspect-ratio: 3210/1080) {
      .event-container {
        width: calc(100vh * 3210 / 1080);
        height: 100vh;
      }
    }

    .border-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 6px solid white;
      box-sizing: border-box;
      z-index: 1000;
      pointer-events: none;
    }

    .zoom-content {
      position: absolute;
      top: 6px;
      left: 6px;
      width: calc(100% - 12px);
      height: calc(100% - 12px);
      overflow: hidden;
    }

    .event {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      opacity: 0;
      z-index: 0;
      pointer-events: auto;
      transition: opacity 2s ease-in-out;
      background-repeat: no-repeat;
      box-sizing: border-box;
    }

    .event.visible {
      opacity: 1;
      z-index: 1;
    }

    .event::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 0;
    }

    .event-overlay {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 1;
      transform-origin: 5.2% 44.4%;
    }

    .event-title {
      position: absolute;
      bottom: 44.4%;
      left: 5.2%;
      max-width: 52%;
      font-size: clamp(2rem, 7.5vw, 7.5rem);
      font-weight: bold;
      line-height: 1;
      opacity: 1.0;
      color: #ccc;
      word-break: keep-all;
      overflow-wrap: break-word;
    }

    .event-description {
      position: absolute;
      bottom: 23.1%;
      left: 5.2%;
      max-width: 72.9%;
      font-size: clamp(1rem, 3.2vw, 3.2rem);
      line-height: 1;
      opacity: 0.9;
      color: #ccc;
    }

    .event-time {
      position: absolute;
      bottom: 9.3%;
      left: 5.2%;
      font-size: clamp(0.8rem, 2.8vw, 2.8rem);
      color: #ccc;
      opacity: 0.9;
      line-height: 1.2;
    }

    .countdown {
      position: absolute;
      bottom: 54%;
      left: 5.2%;
      font-size: clamp(1.2rem, 4vw, 4rem);
      color: #fff;
      opacity: 1;
      font-weight: bold;
      text-align: left;
      line-height: 1.2;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    }

    .countdown-label {
      font-size: 0.5em;
      display: block;
      opacity: 0.8;
      font-weight: normal;
      margin-bottom: 0.2em;
    }

    #loadingSpinner {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 2rem;
      font-family: sans-serif;
    }

    .emoji-eye {
      display: inline-block;
      width: 1em;
      height: auto;
      vertical-align: middle;
      max-width: 1em;
      max-height: 1em;
      object-fit: contain;
      line-height: 1;
    }

    .no-break-look {
      white-space: nowrap !important;
      display: inline-block;
      word-break: keep-all;
      overflow-wrap: normal;
    }
  </style>
</head>
<body>

  <div id="loadingSpinner">Loading events‚Ä¶</div>
  
  <div class="event-container" id="eventContainer">
    <div class="border-overlay"></div>
    <div class="zoom-content" id="zoomContent"></div>
  </div>

  <div id="zoom-controls">
    <button class="zoom-button" onclick="previousEvent()">‚Üê</button>
    <button class="zoom-button" onclick="nextEvent()">‚Üí</button>
    <button class="zoom-button" onclick="changeZoom(-0.1)">‚àí</button>
    <button class="zoom-button" onclick="changeZoom(0.1)">+</button>
  </div>

  <script>
    let zoomLevel = 1;
    let currentEventIndex = 0;
    let allEvents = [];
    let countdownInterval = null;

    function parseEventDateTime(description) {
      // Parse time strings like "October 1, 2025, 10 a.m. - 2 p.m."
      try {
        // First parse the HTML to extract the time paragraph
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = description;
        const timeP = tempDiv.querySelector('p');
        const timeString = timeP ? timeP.textContent.trim() : description;
        
        // Extract date components
        const dateMatch = timeString.match(/(\w+)\s+(\d{1,2}),\s+(\d{4})/);
        let eventDate = new Date();
        
        if (dateMatch) {
          const monthName = dateMatch[1];
          const day = parseInt(dateMatch[2]);
          const year = parseInt(dateMatch[3]);
          const monthMap = {
            'January': 0, 'February': 1, 'March': 2, 'April': 3, 'May': 4, 'June': 5,
            'July': 6, 'August': 7, 'September': 8, 'October': 9, 'November': 10, 'December': 11
          };
          const month = monthMap[monthName];
          eventDate = new Date(year, month, day);
        } else {
          return null;
        }
        
        // Extract start time - handle both "a.m./p.m." and "AM/PM"
        const timePattern = /(\d{1,2})(?::(\d{2}))?\s*([ap]\.?m\.?)/gi;
        const matches = Array.from(timeString.matchAll(timePattern));
        
        if (matches.length === 0) return null;

        const parseTime = (match) => {
          let hours = parseInt(match[1]);
          const minutes = match[2] ? parseInt(match[2]) : 0;
          const meridiem = match[3].toLowerCase().replace(/\./g, '');

          // Convert to 24-hour format
          if (meridiem === 'pm' && hours !== 12) {
            hours += 12;
          } else if (meridiem === 'am' && hours === 12) {
            hours = 0;
          }

          return new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate(), hours, minutes, 0);
        };

        const startTime = parseTime(matches[0]);
        
        console.log('Parsed time from:', timeString, '‚Üí', startTime);
        
        return startTime;
      } catch (e) {
        console.error('Error parsing time:', e);
        return null;
      }
    }

    function formatCountdown(ms) {
      if (ms <= 0) {
        return '<span class="countdown-label">EVENT HAS STARTED</span>';
      }

      const days = Math.floor(ms / (1000 * 60 * 60 * 24));
      const hours = Math.floor((ms % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((ms % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((ms % (1000 * 60)) / 1000);

      let parts = [];
      if (days > 0) parts.push(`${days}d`);
      if (hours > 0 || days > 0) parts.push(`${hours}h`);
      if (minutes > 0 || hours > 0 || days > 0) parts.push(`${minutes}m`);
      parts.push(`${seconds}s`);

      return `<span class="countdown-label">STARTS IN</span>${parts.join(' ')}`;
    }

    function updateCountdowns() {
      const now = new Date().getTime();
      document.querySelectorAll('.countdown').forEach(countdown => {
        const eventTime = parseInt(countdown.dataset.eventTime);
        if (eventTime) {
          const diff = eventTime - now;
          countdown.innerHTML = formatCountdown(diff);
        }
      });
    }

    function startCountdownTimer() {
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(updateCountdowns, 1000);
      updateCountdowns();
    }

    function changeZoom(delta) {
      zoomLevel = Math.min(Math.max(zoomLevel + delta, 0.5), 2);
      const overlays = document.querySelectorAll('.event-overlay');
      overlays.forEach(overlay => {
        overlay.style.transform = `scale(${zoomLevel})`;
      });
    }

    function nextEvent() {
      if (allEvents.length === 0) return;
      
      const current = document.querySelector('.event.visible');
      if (current) current.classList.remove('visible');
      
      currentEventIndex = (currentEventIndex + 1) % allEvents.length;
      allEvents[currentEventIndex].classList.add('visible');
    }

    function previousEvent() {
      if (allEvents.length === 0) return;
      
      const current = document.querySelector('.event.visible');
      if (current) current.classList.remove('visible');
      
      currentEventIndex = (currentEventIndex - 1 + allEvents.length) % allEvents.length;
      allEvents[currentEventIndex].classList.add('visible');
    }

    // üëÄ Helper function for safe replacements
    function processTitleWithEyes(title) {
      let processedTitle = title
        .replace(/LüëÄk:/g, '<span class="no-break-look">L<img src="https://raw.githubusercontent.com/CU4thSpace/EVENTS/main/emoji-eyes.png" alt="üëÄ" class="emoji-eye">k:</span>')
        .replace(/LüëÄK:/g, '<span class="no-break-look">L<img src="https://raw.githubusercontent.com/CU4thSpace/EVENTS/main/emoji-eyes.png" alt="üëÄ" class="emoji-eye">K:</span>')
        .replace(/LüëÄk/g,  '<span class="no-break-look">L<img src="https://raw.githubusercontent.com/CU4thSpace/EVENTS/main/emoji-eyes.png" alt="üëÄ" class="emoji-eye">k</span>')
        .replace(/LüëÄK/g,  '<span class="no-break-look">L<img src="https://raw.githubusercontent.com/CU4thSpace/EVENTS/main/emoji-eyes.png" alt="üëÄ" class="emoji-eye">K</span>');

      // Optional: handle line breaks safely without touching <img src="...">
      processedTitle = processedTitle.replace(/:\s+/g, ':<br>');

      return processedTitle;
    }

    async function fetchAndDisplayEvents() {
      const response = await fetch('https://www.concordia.ca/content/concordia/en/next-gen/4th-space/programming/RSSCAL/_jcr_content/content-main/grid_container_671899525/grid-container-parsys/events_list.xml', {
        cache: 'no-store'
      });
      const text = await response.text();
      const parser = new DOMParser();
      const xml = parser.parseFromString(text, 'application/xml');
      const items = Array.from(xml.querySelectorAll('item'));

      const zoomContent = document.getElementById('zoomContent');
      zoomContent.innerHTML = '';

      const imagePromises = [];
      const eventDivs = [];

      items.forEach(item => {
        const title = item.querySelector('title')?.textContent || 'Untitled';
        const descriptionRaw = item.querySelector('description')?.textContent || '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = descriptionRaw;
        const img = tempDiv.querySelector('img');
        const imageUrl = img ? img.src : 'https://via.placeholder.com/300';

        // Parse event date/time for countdown
        const eventDateTime = parseEventDateTime(descriptionRaw);
        
        // Debug: log what we're getting
        console.log('Title:', title);
        console.log('Description:', descriptionRaw);
        console.log('Parsed DateTime:', eventDateTime);

        const eventDiv = document.createElement('div');
        eventDiv.className = 'event';
        eventDiv.style.backgroundImage = `url(${imageUrl})`;

        const overlay = document.createElement('div');
        overlay.className = 'event-overlay';

        const maxLength = 25;
        const titleDiv = document.createElement('div');
        titleDiv.className = 'event-title';

        // ‚úÖ Use helper for replacements
        let processedTitle = processTitleWithEyes(title);
        titleDiv.innerHTML = processedTitle;

        if (title.length > maxLength) {
          const scale = Math.max(0.7, maxLength / title.length);
          titleDiv.style.fontSize = `clamp(${2 * scale}rem, ${7.5 * scale}vw, ${7.5 * scale}rem)`;
        }

        overlay.appendChild(titleDiv);

        // Add countdown - always show it for debugging
        const countdownDiv = document.createElement('div');
        countdownDiv.className = 'countdown';
        if (eventDateTime) {
          countdownDiv.dataset.eventTime = eventDateTime.getTime();
        } else {
          countdownDiv.innerHTML = '<span class="countdown-label">NO DATE FOUND</span>';
        }
        overlay.appendChild(countdownDiv);

        eventDiv.appendChild(overlay);
        zoomContent.appendChild(eventDiv);
        eventDivs.push(eventDiv);

        const imgLoader = new Image();
        const imgPromise = new Promise(resolve => {
          imgLoader.onload = resolve;
          imgLoader.onerror = resolve;
          imgLoader.src = imageUrl;
        });
        imagePromises.push(imgPromise);
      });

      await Promise.all(imagePromises);
      document.getElementById('loadingSpinner').style.display = 'none';

      allEvents = eventDivs;
      currentEventIndex = 0;

      if (eventDivs.length > 0) {
        eventDivs[0].classList.add('visible');
      }

      const overlays = document.querySelectorAll('.event-overlay');
      overlays.forEach(overlay => {
        overlay.style.transform = `scale(${zoomLevel})`;
      });

      // Start countdown timer
      startCountdownTimer();
    }

    fetchAndDisplayEvents();
    setInterval(fetchAndDisplayEvents, 3*60*60*1000);
  </script>

</body>
</html>